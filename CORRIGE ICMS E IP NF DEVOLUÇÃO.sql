
--###########################################################
--#1 VALIDA icms dif e vopdif

select  
sum(D1_ICMSDIF)D1_ICMSDIF,
sum(D1_VOPDIF)D1_VOPDIF,
sum(D1_VALICM)D1_VALICM,
sum(FT_ICMSDIF)FT_ICMSDIF,
sum(FT_VOPDIF)FT_VOPDIF,
sum(FT_VALICM)FT_VALICM,	
sum(VOP_icms)VOP_icms,	
sum(CALC_icmsdif)CALC_icmsdif,
sum(CALC_VALICM)CALC_VALICM
--SELECT *
from (
select 
FT_BASEICM,D1_ICMSDIF,D1_VOPDIF,D1_VALICM, FT_ICMSDIF,FT_VOPDIF,FT_VALICM
,round(FT_BASEICM * 0.18,2) VOP_icms
,ROUND ((FT_BASEICM * 0.18) * 0.6667,2)CALC_icmsdif
,ROUND((FT_BASEICM * 0.18)- ((FT_BASEICM * 0.18) * 0.6667) ,2)CALC_VALICM
,D1_FILIAL,D1_ITEM,D1_COD,D1_QUANT,D1_VUNIT,D1_TOTAL,D1_PEDIDO,D1_ITEMPC,D1_FORNECE,D1_LOJA,D1_LOCAL,D1_DOC
from SD1010 SD1 (NOLOCK)
JOIN SFT010 SFT (NOLOCK) ON FT_FILIAL=D1_FILIAL AND FT_NFISCAL=D1_DOC AND FT_CLIEFOR=D1_FORNECE AND  D1_COD =FT_PRODUTO AND SFT.D_E_L_E_T_='' AND SD1.D_E_L_E_T_=''
WHERE D1_DOC LIKE '%000011448'
AND D1_FORNECE LIKE'%009284%'
and D1_FILIAL='010101'
and SD1.D_E_L_E_T_=''
)aaa
where FT_VOPDIF<>VOP_icms
or CALC_icmsdif <>FT_ICMSDIF OR CALC_VALICM<>FT_VALICM


--###########################################################
--#2 corrige icms dif e vopdif NAS TABELAS DOS ITENS


BEGIN TRAN
--ROUND((FT_BASEICM * 0.18),2)
	--SELECT ROUND(FT_TOTAL*0.04,2),FT_VALICM, ROUND ((FT_BASEICM * 0.18) * 0.6667,2),FT_ICMSDIF,ROUND((FT_BASEICM * 0.18),2),FT_VOPDIF,FT_VALICM,ROUND((FT_BASEICM * 0.18)- ((FT_BASEICM * 0.18) * 0.6667) ,2),* FROM SFT010
   --UPDATE SFT010 SET FT_ICMSDIF = ROUND ((FT_BASEICM * 0.18) * 0.6667,2),FT_VOPDIF = ROUND((FT_BASEICM * 0.18),2), FT_VALICM=ROUND((FT_BASEICM * 0.18)- ((FT_BASEICM * 0.18) * 0.6667) ,2)
   UPDATE SFT010 SET FT_BASEICM=FT_TOTAL, FT_VALICM=(ROUND(FT_TOTAL*0.04,2)), FT_VALCONT=FT_TOTAL+FT_VALIPI
   WHERE FT_NFISCAL LIKE '%000011448'
   AND FT_FILIAL = '010101'
   --and FT_PRODUTO='000384'
   AND FT_CLIEFOR LIKE'%009284%'
   AND D_E_L_E_T_=''

   SELECT D1_BASEICM,D1_TOTAL,D1_VALICM,D1_TOTAL*0.04, ROUND ((D1_BASEICM * 0.18) * 0.6667,2),D1_ICMSDIF, ROUND((D1_BASEICM * 0.18),2),D1_VOPDIF,D1_VALICM,ROUND((D1_BASEICM * 0.18)- ((D1_BASEICM * 0.18) * 0.6667) ,2),* FROM SD1010    
   --UPDATE SD1010    SET D1_ICMSDIF = ROUND ((D1_BASEICM * 0.18) * 0.6667,2), D1_VOPDIF=(D1_BASEICM * 0.18), D1_VALICM=ROUND((D1_BASEICM * 0.18)- ((D1_BASEICM * 0.18) * 0.6667) ,2)
   --UPDATE SD1010 SET D1_BASEICM=D1_TOTAL, D1_VALICM=(ROUND(D1_TOTAL*0.04,2))
 WHERE D1_DOC  LIKE '%000011448'
   AND D1_FILIAL = '010101'
   --and D1_COD ='000384'
   AND D1_FORNECE LIKE'%009284%'
   AND D_E_L_E_T_=''

--###########################################################
--#3 corrige icms dif e vopdif NAS TABELAS DOS CABEÇALHOS

select F1_VALICM,* 
--BEGIN TRANSACTION UPDATE SF1 SET F1_BASEICM=443.22, F1_VALICM=31.03, F1_BASEIPI=443.22, F1_VALIPI=22.16,F1_BASIMP5 =412.19,F1_BASIMP6 =412.19,F1_VALIMP5 =2.68,F1_VALIMP6 =12.36
--BEGIN TRANSACTION UPDATE SF1 SET F1_VALICM=40.98, F1_BASEICM=1024.50
from SF1010 SF1
WHERE F1_DOC LIKE '%000011448'
AND F1_FILIAL='010101'
AND D_E_L_E_T_=''
AND F1_FORNECE='009284'

SELECT F3_VALICM,F3_ICMSDIF,
F3_BASEICM, F3_VALICM, F3_BASEIPI, F3_VALIPI,F3_BASIMP5,F3_BASIMP6,F3_VALIMP5,F3_VALIMP6,
* 
--BEGIN TRANSACTION UPDATE SF3 SET F3_VALICM=40.98, F3_BASEICM =1024.50, F3_VALCONT=1075.73
--BEGIN TRANSACTION UPDATE SF3 SET F3_BASEICM=443.22, F3_VALICM=31.03, F3_BASEIPI=443.22, F3_VALIPI=22.16,F3_BASIMP5 =412.19,F3_BASIMP6 =412.19,F3_VALIMP5 =2.68,F3_VALIMP6 =12.36, F3_VALCONT=465.38
FROM SF3010 SF3
WHERE F3_NFISCAL LIKE '%000011448'
AND F3_FILIAL='010101'
AND F3_CLIEFOR='009284'
AND D_E_L_E_T_=''

--F3_BASEICM=443.22, F3_VALICM=31.03, F3_BASEIPI=443.22, F3_VALIPI=22.16,F3_BASIMP5 =412.19,F3_BASIMP6 =412.19,F3_VALIMP5 =2.68,F3_VALIMP6 =12.36

--Base ICMS=443,22 ICMS=31,03

--Base IPI=443,22 IPI=22,16

--Base PIS=412,19 Pis=2,68

--Base Cofins=412,19 Cofins 12,36

--###########################################################
--#3 DELETA NF DO TSS PARA PODER TRANSMITIR NOVAMENTE

SELECT D_E_L_E_T_,
CONVERT(varchar(MAX),CONVERT(VARBINARY(MAX), XML_ERP)) as XML_ERP2,
* 
--BEGIN TRANSACTION UPDATE SPED SET D_E_L_E_T_ ='*', 	R_E_C_D_E_L_ =R_E_C_N_O_
 
FROM tss_nfe_producao..SPED050 SPED
WHERE NFE_ID LIKE'%000011448%'

--COMMIT
--ROLLBACK

--D1_ICMSDIF	D1_VOPDIF	D1_VALICM	FT_ICMSDIF	FT_VOPDIF	FT_VALICM	VOP_icms	CALC_icmsdif	CALC_VALICM
--17229,91		25843,5774	8613,67		17229,91	25843,58	8613,67		25843,58	17229,91		8613,67
