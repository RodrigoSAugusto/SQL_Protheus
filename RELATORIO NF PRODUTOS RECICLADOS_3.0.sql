--RELATORIO NF COM PRODUTOS RECICLADOS
--calcular a porcentagem de reciclado em cada item da NF
--grupos de produtos reciclados segundo o Vicente ('PA01', 'PA02', 'PA03', 'PA04', 'PP13' ,'PP14', 'MN34')
select 
F2_FILIAL,F2_DOC,F2_SERIE, F2_EMISSAO,
--SC6.R_E_C_N_O_ C6_REC,SF2.R_E_C_N_O_ F2_REC,SD3A.D3_LOTECTL,SD2.R_E_C_N_O_ D2_REC,SD3A.D3_CF CF_PA, SD3A.D3_NUMSEQ, SD3A.R_E_C_N_O_ D3PA_REC,SD3B.D3_CF CF_PP, SD3B.R_E_C_N_O_ D3PP_REC,
D2_COD COD_PA,
C6_NUMOP,C6_ITEMOP,
SD3A.D3_OP, 
SD3B.D3_LOTECTL,
SD3B.D3_COD COD_PP,
SB1A.B1_DESC DESC_PA,
SB1A.B1_GRUPO GRUPO_PA,
SB1B.B1_DESC DESC_PP,
SB1B.B1_GRUPO GRUPO_PP,
D2_QUANT QTD_NF, 
SD3A.D3_QUANT QTD_PA,
SD3B.D3_QUANT QTD_PP,
D2_CUSTO1 CUSTO_NF,
SD3A.D3_CUSTO1 CUSTO_PA,
SD3B.D3_CUSTO1 CUSTO_PP,
CASE WHEN SD3A.D3_CUSTO1<>0 THEN ROUND(SD3B.D3_CUSTO1/SD3A.D3_CUSTO1*1.0,6) ELSE 0 END PERCENT_CUST_PP
from SF2010 SF2 
JOIN SD2010 SD2 ON D2_FILIAL=F2_FILIAL AND D2_DOC = F2_DOC AND D2_SERIE=F2_SERIE AND SD2.D_E_L_E_T_=''
JOIN SC6010 SC6 ON C6_FILIAL=F2_FILIAL AND C6_NOTA= D2_DOC AND C6_SERIE = D2_SERIE AND D2_COD=C6_PRODUTO AND  SC6.D_E_L_E_T_=''
JOIN SD3010 SD3A ON SD3A.D3_FILIAL=C6_FILIAL AND SUBSTRING(SD3A.D3_OP,1,8)=C6_NUMOP+C6_ITEMOP  AND SD3A.D3_COD=SC6.C6_PRODUTO AND D3_CF='PR0'AND SD3A.D_E_L_E_T_=''
JOIN SD3010 SD3B ON SD3B.D3_FILIAL=SD3A.D3_FILIAL AND SD3B.D3_NUMSEQ=SD3A.D3_NUMSEQ AND SD3B.D3_CF='RE1' AND SD3B.D_E_L_E_T_=''
JOIN SB1010 SB1A ON SB1A.B1_FILIAL=SD3A.D3_FILIAL AND SD3A.D3_COD = SB1A.B1_COD AND SB1A.D_E_L_E_T_=''
JOIN SB1010 SB1B ON SB1B.B1_FILIAL=SD3B.D3_FILIAL AND SD3B.D3_COD = SB1B.B1_COD AND SB1B.D_E_L_E_T_=''
AND SB1B.B1_GRUPO IN('PA01', 'PA02', 'PA03', 'PA04', 'PP13' ,'PP14', 'MN34') 
WHERE  1=1
AND F2_FILIAL ='020101'
AND F2_EMISSAO BETWEEN '20200801' AND '20210120'
--AND C6_NOTA	='000098240'
--and C6_SERIE ='001'

AND SF2.D_E_L_E_T_=''
--AND SD3A.D3_OP='01093801001'
ORDER BY 
F2_FILIAL,F2_DOC,C6_ITEMOP,SC6.R_E_C_N_O_,SD3A.D3_NUMSEQ,SD3B.R_E_C_N_O_
