
--###########################################################
--#1 VALIDA icms dif e vopdif

select  
sum(D1_ICMSDIF)D1_ICMSDIF,
sum(D1_VOPDIF)D1_VOPDIF,
sum(D1_VALICM)D1_VALICM,
sum(FT_ICMSDIF)FT_ICMSDIF,
sum(FT_VOPDIF)FT_VOPDIF,
sum(FT_VALICM)FT_VALICM,	
sum(VOP_icms)VOP_icms,	
sum(CALC_icmsdif)CALC_icmsdif,
sum(CALC_VALICM)CALC_VALICM
--SELECT *
from (
select 
FT_BASEICM,D1_ICMSDIF,D1_VOPDIF,D1_VALICM, FT_ICMSDIF,FT_VOPDIF,FT_VALICM
,round(FT_BASEICM * 0.18,2) VOP_icms
,ROUND ((FT_BASEICM * 0.18) * 0.6667,2)CALC_icmsdif
,ROUND((FT_BASEICM * 0.18)- ((FT_BASEICM * 0.18) * 0.6667) ,2)CALC_VALICM
,D1_FILIAL,D1_ITEM,D1_COD,D1_QUANT,D1_VUNIT,D1_TOTAL,D1_PEDIDO,D1_ITEMPC,D1_FORNECE,D1_LOJA,D1_LOCAL,D1_DOC
from SD1010 SD1 (NOLOCK)
JOIN SFT010 SFT (NOLOCK) ON FT_FILIAL=D1_FILIAL AND FT_NFISCAL=D1_DOC AND FT_CLIEFOR=D1_FORNECE AND  D1_COD =FT_PRODUTO AND SFT.D_E_L_E_T_='' AND SD1.D_E_L_E_T_=''
WHERE D1_DOC LIKE '%000308965'
--AND D1_FORNECE LIKE'%092032%'
   and SD1.D_E_L_E_T_=''
   AND SFT.D_E_L_E_T_=''

)aaa
where FT_VOPDIF<>VOP_icms
or CALC_icmsdif <>FT_ICMSDIF OR CALC_VALICM<>FT_VALICM

--###########################################################
--#2 corrige icms dif e vopdif NAS TABELAS DOS ITENS


BEGIN TRAN
--ROUND((FT_BASEICM * 0.18),2)
	SELECT FT_CLASFIS, FT_BASEICM,ROUND ((FT_BASEICM * 0.18) * 0.6667,2),FT_ICMSDIF,ROUND((FT_BASEICM * 0.18),2),FT_VOPDIF,FT_VALICM,ROUND((FT_BASEICM * 0.18)- ((FT_BASEICM * 0.18) * 0.6667) ,2),* FROM SFT010
   --UPDATE SFT010 SET FT_ICMSDIF = ROUND ((FT_BASEICM * 0.18) * 0.6667,2),FT_VOPDIF = ROUND((FT_BASEICM * 0.18),2), FT_VALICM=ROUND((FT_BASEICM * 0.18)- ((FT_BASEICM * 0.18) * 0.6667) ,2)
   --BEGIN TRAN UPDATE SFT010 SET FT_BASEICM=945,  FT_VALICM=170.1
   --BEGIN TRAN UPDATE SFT010 SET FT_BASEICM=172.5,  FT_VALICM=31.05

 WHERE FT_NFISCAL LIKE '%000308965'
   AND FT_FILIAL = '010102'
   and D_E_L_E_T_=''
   AND FT_CLIEFOR LIKE'%889057%'
   AND FT_ITEM ='0002'

   SELECT D1_CLASFIS,D1_BASEICM, ROUND ((D1_BASEICM * 0.18) * 0.6667,2),D1_ICMSDIF, ROUND((D1_BASEICM * 0.18),2),D1_VOPDIF,D1_VALICM,ROUND((D1_BASEICM * 0.18)- ((D1_BASEICM * 0.18) * 0.6667) ,2),* FROM SD1010    
   ----UPDATE SD1010    SET D1_ICMSDIF = ROUND ((D1_BASEICM * 0.18) * 0.6667,2), D1_VOPDIF=(D1_BASEICM * 0.18), D1_VALICM=ROUND((D1_BASEICM * 0.18)- ((D1_BASEICM * 0.18) * 0.6667) ,2)
   --BEGIN TRAN UPDATE SD1010    SET D1_BASEICM=945,  D1_VALICM=170.1
   --BEGIN TRAN UPDATE SD1010    SET D1_BASEICM=172.5,  D1_VALICM=31.05
 WHERE D1_DOC  LIKE '%000308965'
   --AND D1_FILIAL = '010101'
	--AND D1_FORNECE LIKE'%17156%'
   and D_E_L_E_T_=''
   AND D1_ITEM ='0002'


--   D2_VALICM	D2_BASEICM	D2_FILIAL	D2_ITEM	D2_COD
--		170,1	945			010101		01		027121         
--		31,05	172,5		010101		02		027404         

--###########################################################
--#3 corrige icms dif e vopdif NAS TABELAS DOS CABEÇALHOS

select F1_VALICM,F1_BASEICM,* 
--BEGIN TRANSACTION UPDATE SF1 SET F1_VALICM=201.15 , F1_BASEICM=1117.50 
from SF1010 SF1
WHERE F1_DOC LIKE '%000308965'

SELECT F3_VALICM,F3_ICMSDIF,F3_BASEICM,* 
--BEGIN TRANSACTION UPDATE SF3 SET F3_VALICM=201.15, F3_BASEICM=1117.50 
FROM SF3010 SF3
WHERE 1=1
AND F3_FILIAL='010102'
AND F3_NFISCAL LIKE '%000308965'
and F3_CLIEFOR='889057'
   and D_E_L_E_T_=''

--###########################################################
--#4 DELETA NF DO TSS PARA PODER TRANSMITIR NOVAMENTE

SELECT D_E_L_E_T_,
CONVERT(varchar(MAX),CONVERT(VARBINARY(MAX), XML_ERP)) as XML_ERP2,
* 
--BEGIN TRANSACTION UPDATE SPED SET D_E_L_E_T_ ='*', 	R_E_C_D_E_L_ =R_E_C_N_O_
 
FROM tss_nfe_producao..SPED050 SPED
WHERE NFE_ID LIKE'%000308965%'

--COMMIT
--ROLLBACK

--D1_ICMSDIF	D1_VOPDIF	D1_VALICM	FT_ICMSDIF	FT_VOPDIF	FT_VALICM	VOP_icms	CALC_icmsdif	CALC_VALICM
--11876,28		17813,5524	5937,24		11876,28	17813,55	5937,24		17813,55	11876,28		5937,24



