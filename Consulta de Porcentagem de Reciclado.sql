
-- COLOMBO


SELECT DISTINCT D4_OP, D4_DATA FROM SD4010 WHERE D4_OP IN (
SELECT DISTINCT D3_OP FROM SD3010 WHERE D3_LOTECTL IN (
(SELECT D2_LOTECTL  FROM SD2010 WHERE D2_COD IN (
SELECT DISTINCT D4_PRODUTO FROM SD4010 WHERE D4_COD IN  
('000884','002683','003382','003514','003731','004005',
 '004092','004745','335433','336196','336614','336615',
 '601299','000610','000892','001626','003637','003640',
 '003639','003803','003848','003875','003891','003953',
 '004884','004916','005114','334211','334965','335000',
 '335101','335102','335334','335339','335370','336213',
 '601095','601298','601299') AND D4_FILIAL = '010102' AND D_E_L_E_T_ = '') 
AND D2_FILIAL = '010102' AND D_E_L_E_T_ = '')) 
AND D3_FILIAL = '010102' AND D_E_L_E_T_ = ''	 AND D3_TM = '010'
AND D3_EMISSAO >= '20230721'
AND D3_EMISSAO <= '20230731')
AND D4_FILIAL = '010102' AND D_E_L_E_T_ = ''
AND D4_DATA >= '20230721'
AND D4_DATA <= '20230731'
ORDER BY D4_DATA

select * from SD4010

SELECT  DISTINCT D4_OP
		FROM SD4010
			WHERE  D4_COD IN ('000884','002683','003382','003514','003731','004005','004092','004745','335433','336196','336614','336615','601299') 
				AND D4_FILIAL = '010102' 
				AND D4_PRODUTO <> ''
				AND D4_DATA >= ''
				AND D4_DATA <= ''
				AND D_E_L_E_T_ = ''


SELECT	D4_OP, D4_COD,
		ROUND(100*D4_QTDEORI/(SELECT ROUND(SUM(D4_QTDEORI), 2) 
		FROM SD4010 WHERE D4_OP = '10065901001' AND D4_FILIAL = '010102'), 2) AS 'PERCENT'
			FROM SD4010
			WHERE D4_OP in ('10065901001')
				AND D_E_L_E_T_ = '' AND D4_FILIAL = '010102'
					GROUP BY  D4_OP, D4_COD, D4_QTDEORI



-- Teste Campina grande do sul ------------------------------------------------------------------------

SELECT	D4_OP,
		ROUND(100*D4_QTDEORI/(SELECT ROUND(SUM(D4_QTDEORI), 2) FROM SD4010 WHERE D4_OP = 'I0158301001   ' AND D4_FILIAL = '030102'), 2) AS 'PERCENT',*
			FROM SD4010
			WHERE D4_OP = 'I0158301001   '
				AND D_E_L_E_T_ = '' AND D4_FILIAL = '030102'


	SELECT D2_DOC, D2_EMISSAO, D2_COD, D2_CF, D2_TOTAL, D2_BASEICM, D2_PICM, D2_VALICM FROM SD2010 WHERE D2_LOTECTL IN (
	SELECT D3_LOTECTL FROM SD3010 
	WHERE D3_OP  = 'i0277301001' AND D3_TM = '010'
	AND D3_FILIAL = '030102' AND D_E_L_E_T_ = '')
	AND D2_FILIAL = '030102' AND D_E_L_E_T_ = ''
	AND D2_EMISSAO >= '20220101'
	AND D2_EMISSAO <= '20221130'
	ORDER BY D2_EMISSAO






SELECT DISTINCT D4_OP FROM SD4010 WHERE D4_OP IN (
SELECT DISTINCT D3_OP FROM SD3010 WHERE D3_LOTECTL IN (
(SELECT D2_LOTECTL  FROM SD2010 WHERE D2_COD IN (
SELECT DISTINCT D4_PRODUTO FROM SD4010 WHERE D4_COD IN  
('000052','000764','000253','008187',
'001393','008158','008535','008854',
'008163','008186','008583','008743',
'008183','008110','008088','001385',
'008062','010316','000508','001467',
'000505','001089','001245','000498','001033') 
AND D4_FILIAL = '030102' AND D_E_L_E_T_ = '') 
AND D2_FILIAL = '030102' AND D_E_L_E_T_ = '')) 
AND D3_FILIAL = '030102' AND D_E_L_E_T_ = ''	 AND D3_TM = '010')
AND D4_FILIAL = '030102' AND D_E_L_E_T_ = ''
AND D4_DATA >= '20221101'  AND D4_DATA <= '20221130' 
ORDER BY D4_DATA



--Processo Industrial --------------------------------------------------------


SELECT DISTINCT D4_COD 
			FROM SD4010 inner join SD3010 on D3_FILIAL = D4_FILIAL 
			and D3_OP = D4_OP and D3_COD = D4_COD WHERE D4_OP IN (
			SELECT DISTINCT D3_OP FROM SD3010 WHERE D3_LOTECTL IN (
			(SELECT D2_LOTECTL  FROM SD2010 WHERE D2_COD IN (
			SELECT DISTINCT D4_PRODUTO FROM SD4010 
			WHERE D4_COD IN ('000052','000764','000253','008187',
							'001393','008158','008535','008854',
							'008163','008186','008583','008743',
							'008183','008110','008088','001385',
							'008062','010316','000508','001467',
							'000505','001089','001245','000498','001033') 
			AND D4_FILIAL = '030102' AND D_E_L_E_T_ = '') 
			AND D2_FILIAL = '030102' AND D_E_L_E_T_ = '')) 
			AND D3_FILIAL = '030102' AND D_E_L_E_T_ = '' AND D3_TM = '010') 
			AND D4_FILIAL = '030102' 
			AND SD4010.D_E_L_E_T_ = '' AND SD3010.D_E_L_E_T_ = ''
			AND D4_DATA >= '20221101' AND D4_DATA <= '20221103'

SELECT DISTINCT D4_COD 
				FROM SD4010 inner join SD3010 on D3_FILIAL = D4_FILIAL 
				and D3_OP = D4_OP and D3_COD = D4_COD WHERE D4_OP IN (
				SELECT DISTINCT D3_OP FROM SD3010 WHERE D3_LOTECTL IN (
				(SELECT D2_LOTECTL  FROM SD2010 WHERE D2_COD IN (
				SELECT DISTINCT D4_PRODUTO FROM SD4010 
				WHERE D4_COD IN ('000052','000764','000253','008187',
							'001393','008158','008535','008854',
							'008163','008186','008583','008743',
							'008183','008110','008088','001385',
							'008062','010316','000508','001467',
							'000505','001089','001245','000498','001033') 
				AND D4_FILIAL = '030102' AND D_E_L_E_T_ = '') 
				AND D2_FILIAL = '030102' AND D_E_L_E_T_ = '')) 
				AND D3_FILIAL = '030102' AND D_E_L_E_T_ = '' AND D3_TM = '010') 
				AND D4_FILIAL = '030102' 
				AND SD4010.D_E_L_E_T_ = '' AND SD3010.D_E_L_E_T_ = ''
				AND D4_DATA >= '20221101'  AND D4_DATA <= '20221130' 
			


SELECT DISTINCT D3_LOTECTL FROM
	(SELECT DISTINCT A.D3_LOTECTL, A.D3_OP, A.D3_COD , SUM(A.D3_CUSTO1) QTD_ITEM, B.CUSTO CUSTO_OP, ISNULL(ROUND(SUM(A.D3_CUSTO1)*100/NULLIF(B.CUSTO,0),2),0) '%'  FROM SD3010 A
	INNER JOIN (SELECT D3_FILIAL, D3_OP, SUM(D3_CUSTO1) CUSTO FROM SD3010 
	WHERE D_E_L_E_T_ = ''AND D3_UM <> 'HR' AND D3_TM <> '010'  GROUP BY D3_FILIAL, D3_OP)B 
	ON A.D3_FILIAL = B.D3_FILIAL AND A.D3_OP = B.D3_OP 
	WHERE A.D3_FILIAL = '020101' AND A.D_E_L_E_T_ = ''
	AND A.D3_UM <> 'HR' AND A.D3_TM <> '010'
	AND A.D3_EMISSAO >= '20221101' AND A.D3_EMISSAO <= '20221130'
	AND D3_COD IN (
					SELECT DISTINCT D4_COD 
					FROM SD4010 inner join SD3010 on D3_FILIAL = D4_FILIAL 
					and D3_OP = D4_OP and D3_COD = D4_COD WHERE D4_OP IN (
					SELECT DISTINCT D3_OP FROM SD3010 WHERE D3_LOTECTL IN (
					(SELECT D2_LOTECTL  FROM SD2010 WHERE D2_COD IN (
					SELECT DISTINCT D4_PRODUTO FROM SD4010 
					WHERE D4_COD IN ('004182','042361','041495') 
					AND D4_FILIAL = '020101' AND D_E_L_E_T_ = '') 
					AND D2_FILIAL = '020101' AND D_E_L_E_T_ = '')) 
					AND D3_FILIAL = '020101' AND D_E_L_E_T_ = '' AND D3_TM = '010') 
					AND D4_FILIAL = '020101' 
					AND SD4010.D_E_L_E_T_ = '' AND SD3010.D_E_L_E_T_ = ''
					AND D4_DATA >= '20221101' AND D4_DATA <= '20221130'
				)		
	GROUP BY A.D3_LOTECTL,A.D3_FILIAL, A.D3_OP, A.D3_COD, B.CUSTO
	having ROUND(SUM(A.D3_CUSTO1)*100/B.CUSTO,2) >= 75) AS T2

	SELECT DISTINCT D3_LOTECTL FROM
		(SELECT DISTINCT A.D3_LOTECTL, A.D3_OP, A.D3_COD , SUM(A.D3_CUSTO1) QTD_ITEM, B.CUSTO CUSTO_OP, 
		ISNULL(ROUND(SUM(A.D3_CUSTO1)*100/NULLIF(B.CUSTO,0),2),0) '%'  FROM SD3010 A
		INNER JOIN (SELECT D3_FILIAL, D3_OP, SUM(D3_CUSTO1) CUSTO FROM SD3010 
		WHERE D_E_L_E_T_ = ''AND D3_UM <> 'HR' AND D3_TM <> '010'  GROUP BY D3_FILIAL, D3_OP)B 
		ON A.D3_FILIAL = B.D3_FILIAL AND A.D3_OP = B.D3_OP 
		WHERE A.D3_FILIAL = '010102' AND A.D_E_L_E_T_ = ''
		AND A.D3_UM <> 'HR' AND A.D3_TM <> '010'
		AND A.D3_EMISSAO >= '20221201'  AND A.D3_EMISSAO <= '20221230' 
		AND D3_COD in (
'003216','003216','002294','003595','003797','006519','006519','006519','003218','003427','003427','003428','006490','003736','003736','006080','001705','006519','001606','001606','001606','003387','001606','001606','001606','003797','002101',
'006519','002101','001606','001606','002101','001705','002040','001705','003216','003218','003216','002715','003216','001705','001705','003216','003268','002101','003797','001606','002776','002776','002776','001606','001606',
'001705','001705','001705','002040','002715','002715','002715','002715','002715','002281','002281','001705','001705','001705','001705','002776','002776','002776','002776','002776','002776','001705','001606','001606','001606','001606','001606','001606','001606','002114',
'002114','002114','002114','002114','002114','001705','001705','001606','002101','002776','002776','001606','001606','002776','002776','002776','002715','001705','001606','001606','001606','001606','002776','002776','003213','003213','003213','003213','001606','002101','001606'
)       
		GROUP BY A.D3_LOTECTL, A.D3_FILIAL, A.D3_OP, A.D3_COD, B.CUSTO
		having ISNULL(ROUND(SUM(A.D3_CUSTO1)*100/NULLIF(B.CUSTO,0),2),0) >= 75) AS T2








SELECT D2_DOC, D2_EMISSAO, D2_COD, D2_CF, D2_TOTAL, D2_BASEICM, D2_PICM, D2_VALICM,* FROM SD2010 WHERE D2_LOTECTL IN (
	SELECT DISTINCT D3_LOTECTL FROM SD3010 
	WHERE D3_OP  = '3400301002' AND D3_TM = '010'
	AND D3_FILIAL = '020101' AND D_E_L_E_T_ = ''
	AND D3_COD IN (SELECT DISTINCT D4_COD 
					FROM SD4010 inner join SD3010 on D3_FILIAL = D4_FILIAL 
					and D3_OP = D4_OP and D3_COD = D4_COD WHERE D4_OP IN (
					SELECT DISTINCT D3_OP FROM SD3010 WHERE D3_LOTECTL IN (
					(SELECT D2_LOTECTL  FROM SD2010 WHERE D2_COD IN (
					SELECT DISTINCT D4_PRODUTO FROM SD4010 
					WHERE D4_COD IN ('004182','042361','041495') 
					AND D4_FILIAL = '020101' AND D_E_L_E_T_ = '') 
					AND D2_FILIAL = '020101' AND D_E_L_E_T_ = '')) 
					AND D3_FILIAL = '020101' AND D_E_L_E_T_ = '' AND D3_TM = '010') 
					AND D4_FILIAL = '020101' 
					AND SD4010.D_E_L_E_T_ = '' AND SD3010.D_E_L_E_T_ = ''
					AND D4_DATA >= '20221101' AND D4_DATA <= '20221103'
				))
	AND D2_FILIAL = '020101' AND D_E_L_E_T_ = ''
	AND D2_EMISSAO >= '20221101'
	AND D2_EMISSAO <= '20221131'
	




	-- NOVA CONSULTA

SELECT DISTINCT D3_LOTECTL FROM SD3010 WHERE D3_FILIAL = '030102' 
AND D3_EMISSAO >= '20221101' 
AND D3_EMISSAO <= '20221230' AND D3_OP IN (
SELECT DISTINCT D4_OP FROM (
SELECT D4_FILIAL, D4_DATA, D4_OP, D4_COD , D4_QTDEORI, QTDE FROM SD4010 D4
INNER JOIN (SELECT D4_FILIAL FILIAL, D4_OP OP , SUM (D4_QTDEORI) QTDE 
FROM SD4010 
WHERE D4_FILIAL = '030102' 
AND D4_DATA >= '20221101' AND D4_DATA <= '20221230' AND D_E_L_E_T_ = ''
GROUP BY  D4_FILIAL , D4_OP) A ON D4.D4_FILIAL = A.FILIAL AND D4.D_E_L_E_T_ = ''
AND D4.D4_OP = A.OP
WHERE 1=1
AND D4_OP IN (SELECT D4_OP FROM SD4010 WHERE D4_COD IN ('000052','000764','000253','008187','001393','008158','008535','008854','008163','008186',
'008583','008743','008183','008110','008088','001385','008062','010316') AND D_E_L_E_T_ = '' AND D4_FILIAL = '030102')) as t1)
GROUP BY D3_LOTECTL, D3_CUSTO1






---------------------------------------------------------------------------------------------------------------------------------------------------
--consulta nova colombo

SELECT * FROM SF2010 WHERE F2_DOC IN ( 
SELECT DISTINCT D2_DOC  FROM SD2010 WHERE D2_LOTECTL IN (

SELECT D3_LOTECTL FROM SD3010 WHERE D3_OP IN (
SELECT D3_OP FROM (
SELECT D3_FILIAL, D3_OP, D3_TM , D3_COD , SUM(D3_CUSTO1) C3_CUSTO1 , CUS, 
ROUND(SUM(D3_CUSTO1)/ CUS *100,2) 'PERCENT'
FROM SD3010
INNER JOIN(
SELECT D3_FILIAL FILIAL, D3_OP OP , SUM(D3_CUSTO1) CUS FROM SD3010 
WHERE D3_OP IN 
(SELECT DISTINCT D4_OP 
FROM SD4010 
WHERE D4_COD IN ('000884',
'002683','003382','003514',
'003731','004005','004092',
'004745','335433','336196',
'336614','336615','601299')
AND D4_FILIAL = '010102' AND D_E_L_E_T_ = '')
AND D3_FILIAL = '010102'	
AND D3_TM >= '500' AND D_E_L_E_T_ = '' AND D3_ESTORNO <> 'S'
GROUP BY D3_FILIAL, D3_OP)A ON FILIAL = D3_FILIAL AND D3_OP = OP
WHERE D3_FILIAL = '010102'	
AND D3_TM >= '500' AND D_E_L_E_T_ = '' AND D3_ESTORNO <> 'S'
AND D3_CUSTO1 <> 0
GROUP BY D3_FILIAL, D3_OP, D3_TM , D3_COD, CUS
HAVING ROUND(SUM(D3_CUSTO1)/ CUS *100,2) >= 75 ) A)
AND D3_FILIAL = '010102'  AND D3_ESTORNO <> 'S' AND D_E_L_E_T_ = '' AND D3_TM = '010')
AND D2_FILIAL = '010102' AND D2_EMISSAO >= '20230701'AND D2_EMISSAO <= '20230731' AND D_E_L_E_T_ = '')
AND F2_FILIAL = '010102' AND D_E_L_E_T_ = ''





