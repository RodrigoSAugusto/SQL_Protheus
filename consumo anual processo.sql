DECLARE @CODINI VARCHAR(15)
DECLARE @CODFIM VARCHAR(15)
DECLARE @FILIAL VARCHAR(6)
DECLARE @DTINI VARCHAR(8)
DECLARE @DTFIM VARCHAR(8)


SET @CODINI = '002221'
SET @CODFIM = '002221'
SET @FILIAL = '020101'
SET @DTINI  = '20221231' 
SET @DTFIM  = '20231231'

SELECT 
  B1_FILIAL
, B1_ORIGEM
, B1_COD
, B1_DESC
, B1_GRUPO
, BM_DESC
, B1_LOCPAD
, NNR_DESCRI 
, ISNULL(SLD_INI_2023,0) SLD_INI_2023
, ISNULL(NF_ENTRADA,0) NF_ENTRADA
, ISNULL(MOV_INT_ENTRADA,0) MOV_INT_ENTRADA
, ISNULL(NF_SAIDA,0) NF_SAIDA
, ISNULL(MOV_INT_SAIDA,0) MOV_INT_SAIDA
, ISNULL(SLD_FIM_2023,0) SLD_FIM_2023
, ROUND(ISNULL(SLD_INI_2023,0) + ISNULL(NF_ENTRADA,0) - ISNULL(SLD_FIM_2023,0),2) CONSUMO
FROM SB1010 B1
LEFT OUTER JOIN SBM010 MB ON BM_FILIAL = B1_FILIAL
AND        BM_GRUPO = B1_GRUPO 
and        B1.D_E_L_E_T_ = '' 
And        MB.D_E_L_E_T_ = ''
INNER JOIN NNR010 NNR ON NNR_CODIGO = B1_LOCPAD AND NNR_FILIAL = B1_FILIAL
LEFT OUTER JOIN
(SELECT B9_FILIAL, B9_COD, B9_LOCAL, B9_DATA, B9_QINI SLD_INI_2023 FROM SB9010 WHERE B9_COD BETWEEN @CODINI AND @CODFIM AND B9_DATA IN (@DTINI) AND B9_FILIAL = @FILIAL AND D_E_L_E_T_ = '' )A
ON B1_FILIAL = A.B9_FILIAL AND B1_COD = A.B9_COD AND B1_LOCPAD = A.B9_LOCAL
LEFT OUTER JOIN 
(SELECT D1_FILIAL, D1_COD, D1_LOCAL, SUM(D1_QUANT) NF_ENTRADA FROM SD1010 WHERE D1_COD BETWEEN @CODINI AND @CODFIM AND D1_FILIAL = @FILIAL AND D_E_L_E_T_ = '' AND D1_EMISSAO BETWEEN @DTINI AND @DTFIM 
AND D1_TES NOT IN ('118', '123', '124', '125', '126', '127', '128', '129', '130', '131', '132', '133', '134', '135', '136', '137', '138', '139', '140', '141', '142', '143', '144', '145', '146', '147', '157', '165', '174', '175', '176', '177', '178', '214', '215', '225', '317')
GROUP BY D1_FILIAL, D1_COD, D1_LOCAL)B
ON B1_FILIAL = B.D1_FILIAL AND B1_COD = B.D1_COD AND B1_LOCPAD = B.D1_LOCAL
LEFT OUTER JOIN 
(SELECT D3_FILIAL, D3_COD, D3_LOCAL, SUM(D3_QUANT) MOV_INT_ENTRADA  FROM SD3010 WHERE D3_COD BETWEEN @CODINI AND @CODFIM AND D3_FILIAL = @FILIAL AND D3_ESTORNO = '' AND D_E_L_E_T_ = '' AND D3_TM <= 499 AND  D3_EMISSAO BETWEEN @DTINI AND @DTFIM GROUP BY D3_FILIAL, D3_COD, D3_LOCAL)F
ON B1_FILIAL = F.D3_FILIAL AND B1_COD = F.D3_COD AND B1_LOCPAD = F.D3_LOCAL
LEFT OUTER JOIN 
(SELECT D2_FILIAL, D2_COD, D2_LOCAL, SUM(D2_QUANT) NF_SAIDA  FROM SD2010 WHERE D2_COD BETWEEN @CODINI AND @CODFIM AND D2_FILIAL = @FILIAL AND D_E_L_E_T_ = '' AND D2_EMISSAO BETWEEN @DTINI AND @DTFIM GROUP BY D2_FILIAL, D2_COD, D2_LOCAL)C
ON B1_FILIAL = C.D2_FILIAL AND B1_COD = C.D2_COD AND B1_LOCPAD = C.D2_LOCAL
LEFT OUTER JOIN 
(SELECT D3_FILIAL, D3_COD, D3_LOCAL, SUM(D3_QUANT) MOV_INT_SAIDA  FROM SD3010 WHERE D3_COD BETWEEN @CODINI AND @CODFIM AND D3_FILIAL = @FILIAL AND D3_ESTORNO = '' AND D_E_L_E_T_ = '' AND D3_TM > 499 AND  D3_EMISSAO BETWEEN @DTINI AND @DTFIM GROUP BY D3_FILIAL, D3_COD, D3_LOCAL)D
ON B1_FILIAL = D.D3_FILIAL AND B1_COD = D.D3_COD AND B1_LOCPAD = D.D3_LOCAL
LEFT OUTER JOIN 
(SELECT B9_FILIAL, B9_COD, B9_LOCAL, B9_DATA, B9_QINI SLD_FIM_2023 FROM SB9010 WHERE B9_COD BETWEEN @CODINI AND @CODFIM AND B9_DATA IN (@DTFIM) AND B9_FILIAL = @FILIAL AND D_E_L_E_T_ = '')E
ON B1_FILIAL = E.B9_FILIAL AND B1_COD = E.B9_COD AND B1_LOCPAD  = E.B9_LOCAL
WHERE 1=1
AND B1_FILIAL = @FILIAL
AND B1_COD BETWEEN @CODINI AND @CODFIM
AND        B1_TIPO NOT IN ('PA')
AND        B1_TIPO IN ('MP')
--Telas Ny-Pes
--AND        B1_GRUPO IN
--('MN10','MN13','MI10','MI13')

-- TecidosFV-Teflon
--AND        B1_GRUPO IN
--('MI65','MI66','MI67')

--Aço-Arame
--AND        B1_GRUPO IN
--('MI35','MI36')

--Fio Arame
--AND        B1_GRUPO IN
--('MN68','MI80')

--Tela Esteira
--AND        B1_GRUPO IN
--('MI50','MI51','MI52','MI58','MI59','MI60')

--Fibras
--AND        B1_GRUPO IN
--('MN34','MN39','MI26','MI27','MI28')

--Quimico
--AND        B1_GRUPO IN
--('OI20','OI30','OI49')
ORDER BY B1_FILIAL, B1_COD, B1_GRUPO,B1_LOCPAD, SLD_INI_2023, NF_ENTRADA, MOV_INT_ENTRADA